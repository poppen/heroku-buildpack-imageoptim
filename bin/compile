#!/bin/bash

set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="vendor"

declare -a PACKAGES=("advancecomp-1.18" "gifsicle-1.77" "jhead-2.97" "libjpeg-turbo-1.3.0" "jpegoptim-1.2.4" "optipng-0.7.4" "pngcrush-1.7.60")

indent() {
    sed -u 's/^/       /'
}

deploy() {
    package=$1

    echo "-----> Installing $package"
    DOWNLOAD_URL="http://poppen.github.io/heroku-binaries/libs/${package}.tar.gz"

    echo "DOWNLOAD_URL = " $DOWNLOAD_URL | indent
    curl -L --silent $DOWNLOAD_URL | tar xz

    echo "exporting PATH and LIBRARY_PATH" | indent
    PROFILE_PATH="$BUILD_DIR/.profile.d/${package}.sh"
    echo 'PATH="$PATH:$HOME/vendor/'"$package"'"' > $PROFILE_PATH
}

mkdir -p $BUILD_DIR $CACHE_DIR
mkdir -p $BUILD_DIR/.profile.d

cd $BUILD_DIR
mkdir -p $VENDOR_DIR
cd $VENDOR_DIR

for package in ${PACKAGES[@]}; do
    deploy $package
done

# Fix PATH of gifsicle
echo 'PATH="$PATH:$HOME/vendor/gifsicle-1.77/src"' > $BUILD_DIR/.profile.d/gifsicle-1.77.sh

# add temporary PATH to solve the problem using heroku-buildpack-multi
mkdir -p ${HOME}/${VENDOR_DIR}
for package in ${PACKAGES[@]}; do
    cp -r ${BUILD_DIR}/${VENDOR_DIR}/${package} ${HOME}/${VENDOR_DIR}
    export PATH="$PATH:$HOME/vendor/${package}"
done
export PATH="$PATH:$HOME/vendor/gifsicle-1.77/src"
